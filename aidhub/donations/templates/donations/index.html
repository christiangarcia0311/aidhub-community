<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AidHub Community</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Add Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            overflow-y: auto; /* Add scroll for whole modal */
        }
        .modal-content {
            background-color: white;
            margin: 5% auto; /* Reduce top margin */
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            overflow: visible; /* Change from hidden to visible */
            animation: modalFade 0.3s;
            max-height: 90vh; /* Set maximum height */
            display: flex;
            flex-direction: column;
        }
        .modal-content > div {
            flex: 1;
            overflow-y: auto; /* Add scroll for content */
            padding: 1.5rem;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #map-container {
            height: 300px; /* Reduce map height */
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        .marker-popup {
            font-size: 11px;
            max-width: 150px;
            max-height: 200px;
            overflow-y: auto;
        }
        .marker-popup h3 {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            position: sticky;
            top: 0;
            background: white;
            padding: 2px 0;
        }
        .leaflet-popup-content {
            margin: 8px;
            max-height: 250px;
            overflow-y: auto;
        }
        .leaflet-popup {
            max-height: 300px;
        }
        .urgency-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            margin-top: 1px;
        }
        #recipients-list {
            max-height: 200px; /* Reduce recipient list height */
            overflow-y: auto;
        }
        .trend-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .trend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .trend-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .trend-stats {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.875rem;
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .trend-urgent {
            animation: pulse 2s infinite;
        }

        /* Add these styles for disabled button and loader */
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loader {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid currentColor;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .donation-method-tab {
            transition: all 0.3s;
        }
        .donation-method-tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .modal-content.wide-content {
            max-width: 1000px;  /* Increase from 600px to 1000px */
            width: 95%;
        }
        
        .modal-content.wide-content #map-container {
            height: 400px;
            width: 100%;
            margin-bottom: 0;
        }
        
        .modal-content.wide-content #recipients-list {
            max-height: 400px; /* Match map height */
            padding-right: 10px;
        }

        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .location-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .location-suggestion:hover {
            background-color: #f3f4f6;
        }

        .location-input-wrapper {
            position: relative;
        }

        .leaflet-popup {
            transition: z-index 0.1s;
            z-index: 650;
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
    // Get EmailJS config from Django template
    const emailjsConfig = {
        publicKey: '{{ settings.EMAILJS_CONFIG.PUBLIC_KEY|escapejs }}',
        serviceId: '{{ settings.EMAILJS_CONFIG.SERVICE_ID|escapejs }}',
        templateId: '{{ settings.EMAILJS_CONFIG.TEMPLATE_ID|escapejs }}'
    };
    
    (function() {
        emailjs.init(emailjsConfig.publicKey);
    })();

    // Add these functions at the start of the script tag
    function getFormattedAddress(latitude, longitude) {
        return new Promise((resolve, reject) => {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        resolve(data.display_name);
                    } else {
                        reject('Could not get address');
                    }
                })
                .catch(reject);
        });
    }

    function getCurrentLocation(inputId) {
        const input = document.getElementById(inputId);
        const useLocationBtn = document.querySelector(`[data-for="${inputId}"]`);
        
        if (!navigator.geolocation) {
            showNotification('Geolocation is not supported by your browser', 'error');
            return;
        }

        useLocationBtn.disabled = true;
        useLocationBtn.innerHTML = '<div class="loader"></div> Getting location...';

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const address = await getFormattedAddress(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    input.value = address;
                    useLocationBtn.disabled = false;
                    useLocationBtn.innerHTML = 'Use Current Location';
                    showNotification('Location updated successfully', 'success');
                } catch (error) {
                    console.error('Error getting address:', error);
                    useLocationBtn.disabled = false;
                    useLocationBtn.innerHTML = 'Use Current Location';
                    showNotification('Could not get your address', 'error');
                }
            },
            (error) => {
                console.error('Geolocation error:', error);
                useLocationBtn.disabled = false;
                useLocationBtn.innerHTML = 'Use Current Location';
                showNotification('Could not get your location', 'error');
            }
        );
    }

    let debounceTimer;

    function debounce(func, delay) {
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        }
    }

    function handleLocationInput(input, suggestionsId) {
        const suggestionsDiv = document.getElementById(suggestionsId);
        const query = input.value.trim();
        
        if (query.length < 3) {
            suggestionsDiv.classList.add('hidden');
            return;
        }

        // Show loader while fetching suggestions
        suggestionsDiv.innerHTML = '<div class="p-2 text-center"><div class="loader"></div> Finding locations...</div>';
        suggestionsDiv.classList.remove('hidden');

        debounce(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.slice(0, 5).forEach(place => {
                            const div = document.createElement('div');
                            div.className = 'location-suggestion';
                            div.textContent = place.display_name;
                            div.onclick = () => {
                                input.value = place.display_name;
                                suggestionsDiv.classList.add('hidden');
                            };
                            suggestionsDiv.appendChild(div);
                        });
                        suggestionsDiv.classList.remove('hidden');
                    } else {
                        suggestionsDiv.innerHTML = '<div class="p-2 text-center text-gray-500">No locations found</div>';
                        setTimeout(() => suggestionsDiv.classList.add('hidden'), 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching locations:', error);
                    suggestionsDiv.innerHTML = '<div class="p-2 text-center text-red-500">Error finding locations</div>';
                    setTimeout(() => suggestionsDiv.classList.add('hidden'), 2000);
                });
        }, 300)();
    }

    // Add click event listener to hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        const suggestions = document.querySelectorAll('.location-suggestions');
        suggestions.forEach(suggestion => {
            if (!suggestion.contains(e.target) && !e.target.matches('input')) {
                suggestion.classList.add('hidden');
            }
        });
    });
</script>
</head>
<body class="bg-gray-100 min-h-screen relative">
    <!-- Updated nav with higher z-index -->
    <nav class="bg-blue-600 text-white shadow-lg fixed w-full top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold">AidHub</h1>

        </div>
    </nav>
    <!-- Hero Section -->
    <header class="text-white pt-24 pb-20 relative" style="background: url('https://png.pngtree.com/thumb_back/fh260/background/20230707/pngtree-d-render-of-a-city-map-with-a-location-marker-and-image_3826362.jpg'); background-size: cover; background-repeat: no-repeat;">
        <!-- Add a dark overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        
        <!-- Content with enhanced text shadows -->
        <div class="container mx-auto px-4 text-center relative z-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Connect with AidHub Community</h1>
            <p class="text-xl mb-8 max-w-2xl mx-auto" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                A community-driven platform dedicated to providing support where 
                it matters. Through transparency and direct assistance, you can create 
                real change right now.
            </p>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="showModal('modal-donate')" class="px-8 py-3 rounded-full bg-white text-blue-600 hover:bg-blue-50 font-medium text-lg shadow-lg hover:shadow-xl transition-shadow">Give Support</button>
                <button onclick="showModal('modal-request')" class="px-8 py-3 rounded-full bg-transparent hover:bg-blue-500 border-2 border-white font-medium text-lg shadow-lg hover:shadow-xl transition-shadow">Ask for Support</button>
            </div>
        </div>
    </header>

    <!-- Trending Needs Section -->
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold mb-3">Trending Donation Needs</h2>
                <p class="text-gray-600 max-w-2xl mx-auto">Real-time updates of the most requested donations</p>
            </div>
            <div id="trending-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="loader"></div> Loading trending needs...
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-16 bg-gray-100">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-4">How It Works</h2>
            <p class="text-gray-600 text-center mb-10 max-w-2xl mx-auto">Our platform uses advanced matching algorithms to connect donors directly with those in need, making the donation process simple and transparent.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-lg shadow-lg text-center transform transition-transform hover:scale-105">
                    <div class="text-blue-600 text-5xl mb-4">
                        <!-- Form/Input Icon -->
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">1. Submit Details</h3>
                    <p class="text-gray-600">Share what you'd like to give or what you need. Our AI system analyzes requests to prioritize urgent needs and find the best matches.</p>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg text-center transform transition-transform hover:scale-105">
                    <div class="text-blue-600 text-5xl mb-4">
                        <!-- Connection Icon -->
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">2. Get Matched</h3>
                    <p class="text-gray-600">Our smart matching system connects givers and to those who are in need based on location, urgency and specific needs, ensuring efficient distribution.</p>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg text-center transform transition-transform hover:scale-105">
                    <div class="text-blue-600 text-5xl mb-4">
                        <!-- Handshake Icon -->
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z M9 12l2 2 4-4"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">3. Complete Exchange</h3>
                    <p class="text-gray-600">Connect directly with your match to arrange pickup or delivery. Track your impact and join our community of givers making a difference.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="py-16 bg-blue-600 text-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-10">Our Impact</h2>
            <div id="stats-summary" class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                <div>
                    <div class="text-4xl font-bold mb-2" id="total-donations">0</div>
                    <p>Total Donations</p>
                </div>
                <div>
                    <div class="text-4xl font-bold mb-2" id="unique-donors">0</div>
                    <p>Unique Donors</p>
                </div>
                <div>
                    <div class="text-4xl font-bold mb-2" id="communities-served">0</div>
                    <p>Communities Served</p>
                </div>
            </div>
            <div class="text-center mt-8">
                <button onclick="showModal('modal-history')" class="px-6 py-2 rounded-full bg-white text-blue-600 hover:bg-blue-50 font-medium">View Full History</button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p>© 2025 AidHub - Connecting donors and recipients directly.</p>
            <div class="mt-4">
                <a href="#" onclick="showModal('modal-about'); return false;" class="mx-2 hover:text-blue-300">About</a>
                <a href="#" class="mx-2 hover:text-blue-300">Contact</a>
                <a href="#" class="mx-2 hover:text-blue-300">Privacy Policy</a>
                <a href="#" class="mx-2 hover:text-blue-300">Terms of Service</a>
            </div>
        </div>
    </footer>

    <!-- Donate Modal -->
    <div id="modal-donate" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Offer your Support</h2>
                    <button onclick="closeModal('modal-donate')" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="donate-step-1" class="modal-step">
                    <form id="find-form" class="grid grid-cols-1 gap-4">
                        <input type="hidden" id="donation-type" value="">
                        <!-- Add selection method tabs -->
                        <div class="border-b border-gray-200 mb-4">
                            <div class="flex">
                                <button type="button" onclick="toggleDonationMethod('image')" 
                                        class="px-4 py-2 border-b-2 border-transparent donation-method-tab active"
                                        data-method="image">
                                    Upload Image
                                </button>
                                <button type="button" onclick="toggleDonationMethod('select')"
                                        class="px-4 py-2 border-b-2 border-transparent donation-method-tab"
                                        data-method="select">
                                    Select from List
                                </button>
                            </div>
                        </div>

                        <!-- Image upload section -->
                        <div id="image-upload-section">
                            <div>
                                <label class="block text-gray-700 mb-1">Upload item image you can offer</label>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="donation-image" accept="image/*" class="hidden" onchange="previewImage(event)">
                                    <button type="button" onclick="document.getElementById('donation-image').click()" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        Choose Image
                                    </button>
                                    <span id="selected-file" class="text-sm text-gray-600"></span>
                                </div>
                                <div id="image-preview" class="mt-2 hidden">
                                    <img id="preview-img" class="max-w-full h-48 object-contain rounded border">
                                    <p id="classification-result" class="mt-2 text-sm font-medium"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Dropdown selection section -->
                        <div id="select-type-section" class="hidden">
                            <div>
                                <label class="block text-gray-700 mb-1"></label>
                                <select id="donation-type-select" class="w-full px-3 py-2 border rounded" 
                                        onchange="document.getElementById('donation-type').value = this.value">
                                    <option value="">Choose what you want to give</option>
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Currently requested items</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">Address</label>
                            <div class="flex gap-2">
                                <div class="location-input-wrapper flex-1">
                                    <input type="text" 
                                           id="donor-location" 
                                           class="w-full px-3 py-2 border rounded" 
                                           placeholder="Start typing your location..." 
                                           autocomplete="off"
                                           oninput="handleLocationInput(this, 'donor-location-suggestions')"
                                           required>
                                    <div id="donor-location-suggestions" class="location-suggestions hidden"></div>
                                </div>
                                <button type="button" 
                                        data-for="donor-location"
                                        onclick="getCurrentLocation('donor-location')" 
                                        class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    Use Current Location
                                </button>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Submit Details</button>
                        </div>
                    </form>
                </div>
                
                <div id="donate-step-2" class="modal-step hidden">
                    <h3 class="text-lg font-medium mb-4">Aid Match Results</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="md:w-1/2">
                            <div id="map-container" class="rounded-lg border"></div>
                        </div>
                        <div class="md:w-1/2">
                            <div id="recipients-list" class="space-y-4 overflow-y-auto"></div>
                        </div>
                    </div>
                    <button onclick="showDonateStep(1)" class="mt-4 text-blue-600 hover:text-blue-800">← Back to search</button>
                </div>
                
                <div id="donate-step-3" class="modal-step hidden">
                    <h3 class="text-lg font-medium mb-3">Send Support</h3>
                    <form id="donation-form" class="grid grid-cols-1 gap-4">
                        <input type="hidden" id="recipient-id">
                        <div>
                            <label class="block text-gray-700 mb-1">Your Name</label>
                            <input type="text" id="donor-name" class="w-full px-3 py-2 border rounded" placeholder="Leave blank to donate anonymously">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Email</label>
                            <input type="email" id="donor-contact" class="w-full px-3 py-2 border rounded" placeholder="Enter Email" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="donor-phone" class="w-full px-3 py-2 border rounded" placeholder="Enter Phone Number" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Message</label>
                            <textarea id="donation-message" rows="3" class="w-full px-3 py-2 border rounded" 
                                    placeholder="Describe what you're donating and any special instructions..." required></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Pickup Location</label>
                            <input type="text" id="pickup-location" class="w-full px-3 py-2 border rounded" placeholder="Where can the donation be picked up?" required>
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Send Support</button>
                        </div>
                    </form>
                    <button onclick="showDonateStep(2)" class="mt-4 text-blue-600 hover:text-blue-800">← Back to match results</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Request Aid Modal -->
    <div id="modal-request" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Request Aid</h2>
                    <button onclick="closeModal('modal-request')" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="request-form" class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Organization/Name</label>
                        <input type="text" id="recipient-name" class="w-full px-3 py-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Address </label>
                        <div class="flex gap-2">
                            <div class="location-input-wrapper flex-1">
                                <input type="text" 
                                       id="recipient-location" 
                                       class="w-full px-3 py-2 border rounded" 
                                       placeholder="Start typing your location..." 
                                       autocomplete="off"
                                       oninput="handleLocationInput(this, 'recipient-location-suggestions')"
                                       required>
                                <div id="recipient-location-suggestions" class="location-suggestions hidden"></div>
                            </div>
                            <button type="button"
                                    data-for="recipient-location"
                                    onclick="getCurrentLocation('recipient-location')"
                                    class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Use Current Location
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Need Type</label>
                        <input type="text" id="need-type" class="w-full px-3 py-2 border rounded" placeholder="e.g., food, clothes, medicine, supplies" required>
                    </div>
                    <!-- Add message field for request -->
                    <div>
                        <label class="block text-gray-700 mb-1">Why do you need this support?</label>
                        <textarea id="request-message" rows="3" class="w-full px-3 py-2 border rounded" 
                                placeholder="Please explain your situation and why you need this support..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Email</label>
                        <input type="email" id="recipient-contact" class="w-full px-3 py-2 border rounded" placeholder="Enter Email" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="recipient-phone" class="w-full px-3 py-2 border rounded" placeholder="Enter Phone Number" required>
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="modal-history" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Donation History</h2>
                    <button onclick="closeModal('modal-history')" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Donation Statistics</h3>
                    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="loader"></div> Loading statistics...
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-3">Recent Transactions</h3>
                    <div id="history-container" class="overflow-x-auto max-h-60">
                        <div class="loader"></div> Loading history...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this new modal after other modals but before scripts -->
    <div id="modal-transaction-details" class="modal">
        <div class="modal-content max-w-lg">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Transaction Details</h2>
                    <button onclick="closeModal('modal-transaction-details')" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="transaction-details-content"></div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="modal-about" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">About AidHub</h2>
                    <button onclick="closeModal('modal-about')" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-medium text-blue-600 mb-4">Our Mission</h3>
                    <p class="text-gray-600 leading-relaxed">
                        AidHub is a community-driven platform that connects donors directly with those in need. 
                        Our mission is to streamline the donation process by eliminating intermediaries and using 
                        advanced AI technology to ensure donations reach those who need them most effectively.
                    </p>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-medium text-blue-600 mb-4">Meet Our Team</h3>
                    
                    <h4 class="text-md font-medium text-gray-700 mb-3">Backend Developers</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=christian" alt="Backend Dev 1" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">Christian G. Garcia</h5>
                            <p class="text-sm text-gray-500">Lead Backend Developer</p>
                        </div>
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=renier" alt="Backend Dev 2" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">Mark Renier B. Fostanes</h5>
                            <p class="text-sm text-gray-500">Backend | ML Developer</p>
                        </div>
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=prince" alt="Backend Dev 3" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">Prince Carl S. Ajoc</h5>
                            <p class="text-sm text-gray-500">Backend | ML Developer</p>
                        </div>
                    </div>

                    <h4 class="text-md font-medium text-gray-700 mb-3">Frontend Developers</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=nilo" alt="Frontend Dev 1" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">Nilo Jr. L. Olang</h5>
                            <p class="text-sm text-gray-500">Frontend Lead Developer</p>
                        </div>
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=nathaniel" alt="Frontend Dev 2" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">Nathaniel Paul C. Creencia</h5>
                            <p class="text-sm text-gray-500">UI/UX Designer</p>
                        </div>
                    </div>

                    <h4 class="text-md font-medium text-gray-700 mb-3">Documentation</h4>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="text-center">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=andrei" alt="UI Designer" class="w-32 h-32 rounded-full mx-auto mb-2 object-cover bg-gray-100">
                            <h5 class="font-medium">John Andrei S. Julve</h5>
                            <p class="text-sm text-gray-500">Documentary</p>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-6 text-center">
                    <p class="text-gray-600">
                        Want to join our team? <a href="#" class="text-blue-600 hover:text-blue-800">Contact us</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notification" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transform transition-transform translate-x-full z-50"></div>

    <!-- Load Leaflet JS library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        let map = null;
        let markers = [];
        let donorMarker = null;
        let donorCoordinates = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load trending needs and stats
            fetchTrendingNeeds();
            fetchSummaryStats();
            
            // Find Recipients Form
            document.getElementById('find-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const donationType = document.getElementById('donation-type').value;
                const donorLocation = document.getElementById('donor-location').value;
                fetchRecipients(donationType, donorLocation);
            });

            // Donation Form
            document.getElementById('donation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const recipientId = document.getElementById('recipient-id').value;
                const donorName = document.getElementById('donor-name').value;
                const donorContact = document.getElementById('donor-contact').value;
                const donorPhone = document.getElementById('donor-phone').value;
                const donorLocation = document.getElementById('donor-location').value;
                const donationType = document.getElementById('donation-type').value;
                const pickupLocation = document.getElementById('pickup-location').value;
                
                submitDonation(donorName, donorContact, donorPhone, donationType, donorLocation, pickupLocation, recipientId);
            });

            // Request Form
            document.getElementById('request-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('recipient-name').value;
                const location = document.getElementById('recipient-location').value;
                const donationType = document.getElementById('need-type').value;
                const contact = document.getElementById('recipient-contact').value;
                const phone = document.getElementById('recipient-phone').value;
                
                submitRequest(name, location, donationType, contact, phone);
            });
        });

        // Modal handling
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            if (modalId === 'modal-history') {
                fetchHistory();
            }
            
            if (modalId === 'modal-donate') {
                showDonateStep(1);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Reset forms when closing
            if (modalId === 'modal-donate') {
                document.getElementById('find-form').reset();
                document.getElementById('donation-form').reset();
            } else if (modalId === 'modal-request') {
                document.getElementById('request-form').reset();
            }
        }
        
        // Donation flow steps
        function showDonateStep(step) {
            // Hide all steps
            document.querySelectorAll('.modal-step').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show requested step
            document.getElementById(`donate-step-${step}`).classList.remove('hidden');
            
            // Toggle wide content class
            const modalContent = document.querySelector('#modal-donate .modal-content');
            if (step === 2) {
                modalContent.classList.add('wide-content');
            } else {
                modalContent.classList.remove('wide-content');
            }
        }

        // Initialize the map
        function initMap(lat, lng) {
            // If map already exists, remove it
            if (map !== null) {
                map.remove();
                map = null;
                markers = [];
                donorMarker = null;
            }
            
            // Create new map
            map = L.map('map-container').setView([lat, lng], 12);
            
            // Add tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add donor marker with enhanced popup
            donorMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'donor-marker',
                    html: `<div style="background-color: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [15, 15],
                    iconAnchor: [7, 7]
                })
            }).addTo(map);
            
            // Enhanced donor popup
            const donorPopup = `
                <div class="marker-popup">
                    <h3>Donor</h3>
                    <div>${document.getElementById('donation-type').value}</div>
                    <div class="text-xs text-blue-600 mt-1">You are here</div>
                </div>`;
            donorMarker.bindPopup(donorPopup, {autoClose: false}); // Prevent popup from auto-closing
            donorCoordinates = [lat, lng];
        }
        
        // Add recipient markers to the map
        function addRecipientMarkers(recipients) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Calculate popup offsets based on marker positions
            const positions = new Map(); // Store marker positions for offset calculation
            
            recipients.forEach((recipient, index) => {
                const urgencyColor = getUrgencyColor(recipient.urgency);
                
                // Create position key for clustering
                const posKey = `${recipient.latitude.toFixed(4)},${recipient.longitude.toFixed(4)}`;
                const overlapping = positions.has(posKey) ? positions.get(posKey) : 0;
                positions.set(posKey, overlapping + 1);
                
                // Create custom marker
                const marker = L.marker([recipient.latitude, recipient.longitude], {
                    icon: L.divIcon({
                        className: 'recipient-marker',
                        html: `<div style="background-color: ${urgencyColor}; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [15, 15],
                        iconAnchor: [7, 7]
                    })
                }).addTo(map);
                
                // Calculate offset for this popup
                const offset = L.point(overlapping * 20, -overlapping * 20);
                
                // Create popup content - simplified version
                const popupContent = `
                    <div class="marker-popup">
                        <h3>${recipient.name}</h3>
                        <div class="mt-1">Needs: ${recipient.donation_type}</div>
                        <div class="mt-1">Distance: ${recipient.distance.toFixed(1)} km</div>
                        <button 
                            onclick="selectRecipient(${recipient.id})" 
                            class="mt-2 bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700 w-full"
                        >
                            Send Support
                        </button>
                    </div>
                `;
                
                // Bind popup with calculated offset and increased minWidth
                marker.bindPopup(popupContent, {
                    autoClose: false,
                    offset: offset,
                    minWidth: 150,
                    maxHeight: 300,
                    autoPanPadding: [50, 50]
                });

                // After creating the popup, add click handler for z-index management
                const popup = marker.getPopup();
                popup.on('add', function() {
                    // Set this popup to be on top of others
                    const popupElement = popup.getElement();
                    if (popupElement) {
                        // Reset all popups to default z-index
                        document.querySelectorAll('.leaflet-popup').forEach(p => {
                            p.style.zIndex = '650';
                        });
                        // Set clicked popup to higher z-index
                        popupElement.style.zIndex = '651';
                    }
                });

                markers.push(marker);
                
                // Update list item click handler to manage popup z-index
                document.querySelector(`[data-recipient-id="${recipient.id}"]`)?.addEventListener('click', function() {
                    map.setView([recipient.latitude, recipient.longitude], 12);
                    marker.openPopup();
                    
                    // Set clicked popup to be on top
                    const popupElement = marker.getPopup().getElement();
                    if (popupElement) {
                        document.querySelectorAll('.leaflet-popup').forEach(p => {
                            p.style.zIndex = '650';
                        });
                        popupElement.style.zIndex = '651';
                    }
                });
            });
            
            // Fit map to include all markers
            if (markers.length > 0) {
                const group = new L.featureGroup([donorMarker, ...markers]);
                map.fitBounds(group.getBounds().pad(0.1));
                
                // Open all popups with donor popup last to be on top
                markers.forEach(marker => marker.openPopup());
                donorMarker.openPopup();
            }
        }

        // Get color based on urgency level
        function getUrgencyColor(urgency) {
            if (urgency >= 4) return '#ef4444'; // Red for high urgency
            if (urgency >= 3) return '#f97316'; // Orange for medium-high
            if (urgency >= 2) return '#eab308'; // Yellow for medium
            return '#22c55e'; // Green for low urgency
        }

        // Fetch trending needs
        function fetchTrendingNeeds() {
            fetch('/api/trending')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('trending-container');
                    container.innerHTML = '';
                    
                    if (data.trends && data.trends.length > 0) {
                        data.trends.forEach((trend, index) => {
                            const isUrgent = trend.count > 5; // Adjust threshold as needed
                            const iconBg = getIconBackground(trend.type);
                            const icon = getIconForType(trend.type);
                            
                            container.innerHTML += `
                                <div class="trend-card rounded-xl p-6 ${isUrgent ? 'trend-urgent' : ''}">
                                    <div class="flex items-start">
                                        <div class="trend-icon ${iconBg}">
                                            ${icon}
                                        </div>
                                        <div class="ml-4 flex-1">
                                            <h3 class="text-xl font-semibold mb-2">${trend.type}</h3>
                                            <div class="flex items-center justify-between">
                                                <div class="trend-stats">
                                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    ${trend.count} requests
                                                </div>
                                                ${isUrgent ? '<span class="text-red-500 text-sm font-semibold">High Demand</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 text-gray-600 text-sm">
                                        Most needed in your area. ${isUrgent ? 'Urgent need for donations.' : ''}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        container.innerHTML = '<p class="text-center w-full text-gray-500">No trending needs available at the moment.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching trending data:', error);
                    document.getElementById('trending-container').innerHTML = 
                        '<p class="text-red-500 text-center w-full">Error loading trending needs. Please try again later.</p>';
                });
        }

        // Add helper functions for trending needs
        function getIconBackground(type) {
            const backgrounds = {
                'clothing': 'bg-blue-100 text-blue-600',
                'food': 'bg-green-100 text-green-600',
                'medicine': 'bg-red-100 text-red-600',
                'electronics': 'bg-purple-100 text-purple-600',
                'books': 'bg-yellow-100 text-yellow-600',
                'toys': 'bg-pink-100 text-pink-600',
                'furniture': 'bg-indigo-100 text-indigo-600',
                'hygiene': 'bg-teal-100 text-teal-600',
                'school_supplies': 'bg-orange-100 text-orange-600'
            };
            return backgrounds[type.toLowerCase()] || 'bg-gray-100 text-gray-600';
        }

        function getIconForType(type) {
            const icons = {
                'clothing': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>',
                'food': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3z M16 8a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
                'medicine': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                // Add more icons for other categories
            };
            return icons[type.toLowerCase()] || '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
        }

        // Fetch summary stats for homepage
        function fetchSummaryStats() {
            fetch('/api/summary_stats')
                .then(response => response.json())
                .then(data => {
                    // Ensure numbers are valid and properly formatted
                    const formatStat = (value) => {
                        const num = parseInt(value) || 0;
                        return num.toLocaleString();
                    };
                    
                    document.getElementById('total-donations').textContent = formatStat(data.total_donations);
                    document.getElementById('unique-donors').textContent = formatStat(data.unique_donors);
                    document.getElementById('communities-served').textContent = formatStat(data.communities_served);
                })
                .catch(error => {
                    console.error('Error fetching summary stats:', error);
                    // Set defaults on error
                    document.getElementById('total-donations').textContent = '0';
                    document.getElementById('unique-donors').textContent = '0';
                    document.getElementById('communities-served').textContent = '0';
                });
        }

        // Fetch recipients
        function fetchRecipients(donationType, location) {
            const recipientsList = document.getElementById('recipients-list');
            recipientsList.innerHTML = '<div class="loader"></div> Searching for matching recipients...';
            showDonateStep(2);
            
            fetch(`/api/recipients/?type=${encodeURIComponent(donationType)}&location=${encodeURIComponent(location)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    recipientsList.innerHTML = '';
                    
                    if (data.recipients && data.recipients.length > 0) {
                        // Initialize map with donor location
                        if (data.donor_coordinates) {
                            initMap(data.donor_coordinates.latitude, data.donor_coordinates.longitude);
                        }
                        
                        data.recipients.forEach(recipient => {
                            const urgencyColor = getUrgencyColor(recipient.urgency);
                            
                            recipientsList.innerHTML += `
                                <div class="border rounded p-4 hover:bg-blue-50 cursor-pointer" data-recipient-id="${recipient.id}">
                                    <div class="font-semibold">${recipient.name}</div>
                                    <div class="text-sm text-gray-600">
                                        <div>Location: ${recipient.location} (${recipient.distance.toFixed(1)} km away)</div>
                                        <div>
                                            Need: ${recipient.donation_type} 
                                            <span class="urgency-badge" style="background-color: ${urgencyColor}">
                                                Urgency: ${recipient.urgency.toFixed(1)}/5
                                                <span class="text-xs ml-1">(${(recipient.confidence * 100).toFixed(0)}% conf)</span>
                                            </span>
                                        </div>
                                        <div class="mt-2 text-gray-700">
                                            <strong>Reason for Request:</strong><br>
                                            ${recipient.message || "No reason provided"}
                                        </div>
                                    </div>
                                    <button class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                                        onclick="event.stopPropagation(); selectRecipient(${recipient.id});">Send Support</button>
                                </div>
                            `;
                        });
                        
                        // Add recipient markers to map
                        addRecipientMarkers(data.recipients);
                        
                        // Add click event to list items
                        document.querySelectorAll('[data-recipient-id]').forEach(item => {
                            item.addEventListener('click', function() {
                                const id = this.getAttribute('data-recipient-id');
                                const recipient = data.recipients.find(r => r.id == id);
                                if (recipient) {
                                    map.setView([recipient.latitude, recipient.longitude], 13);
                                    markers.forEach(marker => {
                                        if (marker._latlng.lat === recipient.latitude && 
                                            marker._latlng.lng === recipient.longitude) {
                                            marker.openPopup();
                                        }
                                    });
                                }
                            });
                        });
                    } else {
                        recipientsList.innerHTML = '<p>No matching recipients found for this donation type or location.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching recipients:', error);
                    recipientsList.innerHTML = '<p class="text-red-500">Error finding recipients. Please try again later.</p>';
                });
        }

        // Select a recipient
        function selectRecipient(id) {
            document.getElementById('recipient-id').value = id;
            showDonateStep(3);
        }

        // Submit donation
        function submitDonation(donorName, donorContact, donorPhone, donationType, donorLocation, pickupLocation, recipientId) {
            const message = document.getElementById('donation-message').value;
            const submitButton = document.querySelector('#donation-form button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loader"></div>Processing donation...';

            const data = {
                donor_name: donorName || 'Anonymous Donor',  // Empty string if no name provided
                donor_contact: donorContact,
                donor_phone: donorPhone,
                donation_type: donationType,
                donor_location: donorLocation,
                pickup_location: pickupLocation,
                recipient_id: recipientId,
                message: message  // Add message to payload
            };

            console.log('Submitting donation:', data);

            fetch('/api/donate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                console.log('Server response:', status, body);
                
                if (status !== 200) {
                    throw new Error(body.error || `Server error: ${status}`);
                }
                
                if (!body.success) {
                    throw new Error(body.error || 'Failed to process donation');
                }

                document.getElementById('donation-form').reset();
                document.getElementById('find-form').reset();
                closeModal('modal-donate');
                
                showNotification(`${body.details.donor} donated ${body.details.type} to ${body.details.recipient}`, 'success');
                fetchTrendingNeeds();
                fetchSummaryStats();
            })
            .catch(error => {
                console.error('Donation error:', error);
                showNotification(error.message || 'Error processing donation. Please try again.', 'error');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        }

        // Submit request
        function submitRequest(name, location, donationType, contact, phone) {
            const message = document.getElementById('request-message').value;
            const payload = {
                name: name,
                location: location,
                donation_type: donationType,
                contact: contact,
                phone: phone,
                message: message  // Changed from request_message to message
            };
            
            fetch('/api/add_recipient/', {  // Added trailing slash
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Request added successfully with urgency level: ${data.urgency.toFixed(1)}/5`, 'success');
                    document.getElementById('request-form').reset();
                    closeModal('modal-request');
                    fetchTrendingNeeds();
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting request:', error);
                showNotification('Error processing request. Please try again.', 'error');
            });
        }

        // Fetch donation history
        function fetchHistory() {
            const statsContainer = document.getElementById('stats-container');
            const historyContainer = document.getElementById('history-container');
            statsContainer.innerHTML = '<div class="loader"></div> Loading statistics...';
            historyContainer.innerHTML = '<div class="loader"></div> Loading history...';

            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    // Render stats
                    if (data.type_stats && data.type_stats.length > 0) {
                        statsContainer.innerHTML = data.type_stats.map(stat => `
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <div class="font-medium text-lg">${stat.donation_type}</div>
                                <div class="text-sm text-gray-600">
                                    <div>Total: ${stat.count}</div>
                                    <div>Avg Urgency: ${stat.avg_urgency.toFixed(1)}/5</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        statsContainer.innerHTML = '<p class="text-center text-gray-500">No statistics available.</p>';
                    }

                    // Render transactions with popup details
                    historyContainer.innerHTML = '';
                    if (data.transactions && data.transactions.length > 0) {
                        historyContainer.innerHTML = `
                            <div class="grid gap-4 pb-4">
                                ${data.transactions.map((transaction, index) => {
                                    const dateObj = new Date(transaction.date);
                                    const date = dateObj.toLocaleDateString('en-US', { 
                                        month: 'long', 
                                        day: 'numeric', 
                                        year: 'numeric'
                                    });
                                    const time = dateObj.toLocaleTimeString('en-US', {
                                        hour: 'numeric',
                                        minute: '2-digit',
                                        hour12: true
                                    });
                                    const bgColor = getIconBackground(transaction.donation_type);
                                    
                                    return `
                                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
                                            <div class="p-4 cursor-pointer" onclick="showTransactionDetails(${JSON.stringify(transaction).replace(/"/g, '&quot;')})">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${bgColor.replace('bg-', 'text-').replace('-100', '-800')}">
                                                            ${transaction.donation_type}
                                                        </span>
                                                    </div>
                                                    <span class="text-sm text-gray-500">${date} ${time}</span>
                                                </div>
                                                <div class="mt-2">
                                                    <div class="font-medium">${transaction.donor_name} → ${transaction.recipient_name}</div>
                                                    <div class="text-sm text-gray-600">${transaction.location}</div>
                                                    <div class="text-xs text-blue-600 mt-1">Click to view details</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        historyContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No donation history available.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching history:', error);
                    statsContainer.innerHTML = '<p class="text-red-500">Error loading statistics</p>';
                    historyContainer.innerHTML = '<p class="text-red-500">Error loading history</p>';
                });
        }

        function showTransactionDetails(transaction) {
            const content = document.getElementById('transaction-details-content');
            const dateObj = new Date(transaction.date);
            const date = dateObj.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            const bgColor = getIconBackground(transaction.donation_type);
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${bgColor} ${bgColor.replace('bg-', 'text-').replace('-100', '-800')}">
                            ${transaction.donation_type}
                        </span>
                        <span class="text-sm text-gray-500">${date}</span>
                    </div>
                    
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-medium text-gray-900">Donor Information</h3>
                        <div class="mt-2 space-y-2">
                            <p class="text-sm text-gray-600">Name: ${transaction.donor_name}</p>
                            <p class="text-sm text-gray-600">Contact: <span class="text-blue-600">${transaction.donor_contact}</span></p>
                        </div>
                    </div>
                    
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-medium text-gray-900">Recipient Information</h3>
                        <div class="mt-2 space-y-2">
                            <p class="text-sm text-gray-600">Name: ${transaction.recipient_name}</p>
                            <p class="text-sm text-gray-600">Contact: <span class="text-blue-600">${transaction.recipient_contact}</span></p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Location Details</h3>
                        <div class="mt-2 space-y-2">
                            <p class="text-sm text-gray-600">Pickup Location: ${transaction.pickup_location}</p>
                            <p class="text-sm text-gray-600">Delivery Location: ${transaction.location}</p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('modal-transaction-details');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            // Extract confidence if present
            const confidenceMatch = message.match(/confidence: (\d+%)/);
            if (confidenceMatch) {
                const confidence = confidenceMatch[1];
                message = message.replace(/\(confidence: \d+%\)/, '');
                notification.innerHTML = `${message}<br><span class="text-sm">ML Confidence: ${confidence}</span>`;
            } else {
                notification.textContent = message;
            }
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } text-white z-50`;
            
            // Show notification
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 5000);
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Update selected file name
            document.getElementById('selected-file').textContent = file.name;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('preview-img');
                preview.src = e.target.result;
                document.getElementById('image-preview').classList.remove('hidden');
                
                // Classify image
                classifyDonationImage(file);
            }
            reader.readAsDataURL(file);
        }

        function classifyDonationImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            // Show detecting loader
            const result = document.getElementById('classification-result');
            result.innerHTML = '<div class="loader"></div> Detecting donation type...';
            
            fetch('/api/classify_image/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    result.textContent = `Classified as: ${data.category} (${Math.round(data.confidence * 100)}% confidence)`;
                    document.getElementById('donation-type').value = data.category;
                } else {
                    result.textContent = 'Could not classify image. Please select donation type manually.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                result.textContent = 'Error detecting donation type. Please select manually.';
                showNotification('Error classifying image', 'error');
            });
        }

        function toggleDonationMethod(method) {
            // Update tab styles
            document.querySelectorAll('.donation-method-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.method === method) {
                    tab.classList.add('active');
                }
            });
            
            // Show/hide sections
            const imageSection = document.getElementById('image-upload-section');
            const selectSection = document.getElementById('select-type-section');
            
            if (method === 'image') {
                imageSection.classList.remove('hidden');
                selectSection.classList.add('hidden');
                // Reset select value
                document.getElementById('donation-type-select').value = '';
                // Reset image preview
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('donation-image').value = '';
                document.getElementById('selected-file').textContent = '';
            } else {
                imageSection.classList.add('hidden');
                selectSection.classList.remove('hidden');
                // Load current needs into select
                fetchCurrentNeeds();
                // Reset hidden input
                document.getElementById('donation-type').value = '';
            }
        }

        // Add this new function to fetch current needs
        function fetchCurrentNeeds() {
            const select = document.getElementById('donation-type-select');
            select.innerHTML = '<option value="">Loading current needs...</option>';
            
            fetch('/api/current_needs/')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Choose what you want to donate</option>';
                    if (data.needs && data.needs.length > 0) {
                        // Group needs by type and count
                        const needCounts = data.needs.reduce((acc, need) => {
                            acc[need.donation_type] = (acc[need.donation_type] || 0) + 1;
                            return acc;
                        }, {});
                        
                        // Create options for each need type
                        Object.entries(needCounts)
                            .sort((a, b) => b[1] - a[1]) // Sort by count descending
                            .forEach(([type, count]) => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = `${type} (${count} requests)`;
                                select.appendChild(option);
                            });
                    } else {
                        select.innerHTML = '<option value="">No current needs found</option>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching needs:', error);
                    select.innerHTML = '<option value="">Error loading needs</option>';
                });
        }
    </script>
</body>
</html>